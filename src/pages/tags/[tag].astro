---
import { getCollection } from "astro:content"
import PageLayout from "@layouts/PageLayout.astro"
import TopLayout from "@layouts/TopLayout.astro"
import BottomLayout from "@layouts/BottomLayout.astro"
import ArrowCard from "@components/ArrowCard"
import { getTagIcon } from "@lib/utils"

export async function getStaticPaths() {
  const posts = (await getCollection("blog")).filter((post) => !post.data.draft)
  const projects = (await getCollection("projects")).filter((project) => !project.data.draft)

  // Get all unique tags (lowercase for URL)
  const allTags = new Set<string>()
  posts.forEach((post) => post.data.tags.forEach((tag: string) => allTags.add(tag.toLowerCase())))
  projects.forEach((project) =>
    project.data.tags.forEach((tag: string) => allTags.add(tag.toLowerCase()))
  )

  return [...allTags].map((tag) => ({
    params: { tag },
    props: { tag },
  }))
}

interface Props {
  tag: string
}

const { tag } = Astro.props

const posts = (await getCollection("blog"))
  .filter((post) => !post.data.draft)
  .filter((post) => post.data.tags.some((t: string) => t.toLowerCase() === tag))
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime())

const projects = (await getCollection("projects"))
  .filter((project) => !project.data.draft)
  .filter((project) => project.data.tags.some((t: string) => t.toLowerCase() === tag))
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime())

const totalCount = posts.length + projects.length
const icon = getTagIcon(tag)
---

<PageLayout title={`Tag: ${tag}`} description={`All posts tagged with "${tag}"`}>
  <TopLayout>
    <div class="animate">
      <a
        href="/tags"
        class="group mb-4 flex w-fit items-center gap-1.5 rounded border border-black/15 p-1.5 text-sm transition-colors duration-300 ease-in-out hover:bg-black/5 dark:border-white/20 hover:dark:bg-white/10"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke-width="2.5"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="stroke-current group-hover:stroke-black group-hover:dark:stroke-white"
        >
          <line
            x1="19"
            y1="12"
            x2="5"
            y2="12"
            class="translate-x-3 scale-x-0 transition-all duration-300 ease-in-out group-hover:translate-x-0 group-hover:scale-x-100"
          ></line>
          <polyline
            points="12 19 5 12 12 5"
            class="translate-x-1 transition-all duration-300 ease-in-out group-hover:translate-x-0"
          ></polyline>
        </svg>
        <span
          class="w-full transition-colors duration-300 ease-in-out group-hover:text-black group-hover:dark:text-white"
        >
          All tags
        </span>
      </a>
      <div class="flex items-center gap-3">
        <img
          src={icon.src}
          alt={tag}
          class:list={["size-8 shrink-0", { "dark:invert": icon.needsInvert }]}
        />
        <h1 class="page-heading capitalize">{tag}</h1>
      </div>
      <p class="mt-1 opacity-75">
        {totalCount}
        {totalCount === 1 ? "post" : "posts"} tagged with "{tag}"
      </p>
    </div>
  </TopLayout>
  <BottomLayout>
    <div class="animate">
      {
        posts.length > 0 && (
          <div class="mb-8">
            <h2 class="mb-4 text-sm font-semibold uppercase text-black dark:text-white">
              Blog Posts
            </h2>
            <ul class="flex flex-col gap-3">
              {posts.map((post) => (
                <li>
                  <ArrowCard entry={post} />
                </li>
              ))}
            </ul>
          </div>
        )
      }
      {
        projects.length > 0 && (
          <div>
            <h2 class="mb-4 text-sm font-semibold uppercase text-black dark:text-white">
              Projects
            </h2>
            <ul class="flex flex-col gap-3">
              {projects.map((project) => (
                <li>
                  <ArrowCard entry={project} />
                </li>
              ))}
            </ul>
          </div>
        )
      }
    </div>
  </BottomLayout>
</PageLayout>
