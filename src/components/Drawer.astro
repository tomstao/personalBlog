---
import { SITE, LINKS } from "@consts"
import { cn } from "@lib/utils"
const { pathname } = Astro.url
const subpath = pathname.match(/[^/]+/g)
---

<div
  id="drawer"
  class="fixed inset-0 z-40 flex h-0 flex-col items-center justify-center overflow-hidden bg-neutral-100 transition-[height] duration-300 ease-in-out dark:bg-neutral-900 md:hidden"
>
  <nav class="flex flex-col items-center space-y-2">
    {
      LINKS.map((LINK) => (
        <a
          href={LINK.HREF}
          class={cn(
            "flex items-center justify-center rounded-full px-3 py-1",
            "text-current hover:text-black dark:hover:text-white",
            "hover:bg-black/5 dark:hover:bg-white/20",
            "transition-colors duration-300 ease-in-out",
            "outline-none focus-visible:ring-2 focus-visible:ring-black/50 dark:focus-visible:ring-white/50",
            pathname === LINK.HREF || "/" + subpath?.[0] === LINK.HREF
              ? "pointer-events-none bg-black text-white dark:bg-white dark:text-black"
              : ""
          )}
        >
          {LINK.TEXT}
        </a>
      ))
    }
  </nav>

  <div class="mt-5 flex gap-1">
    <button
      id="drawer-search-button"
      aria-label={`Search blog posts and projects on ${SITE.TITLE}`}
      class="size-9 items-center justify-center rounded-full border border-black/10 bg-transparent stroke-current p-2 outline-none transition-colors duration-300 ease-in-out hover:bg-black/5 hover:stroke-black focus-visible:ring-2 focus-visible:ring-black/50 dark:border-white/25 dark:hover:bg-white/20 hover:dark:stroke-white dark:focus-visible:ring-white/50"
    >
      <svg class="size-full">
        <use href="/ui.svg#search"></use>
      </svg>
    </button>

    <a
      href="/rss.xml"
      target="_blank"
      aria-label={`Rss feed for ${SITE.TITLE}`}
      class="size-9 items-center justify-center rounded-full border border-black/10 bg-transparent stroke-current p-2 outline-none transition-colors duration-300 ease-in-out hover:bg-black/5 hover:stroke-black focus-visible:ring-2 focus-visible:ring-black/50 dark:border-white/25 dark:hover:bg-white/20 hover:dark:stroke-white dark:focus-visible:ring-white/50"
    >
      <svg class="size-full">
        <use href="/ui.svg#rss"></use>
      </svg>
    </a>

    <button
      id="drawer-theme-button"
      aria-label={`Toggle light and dark theme`}
      class="size-9 items-center justify-center rounded-full border border-black/10 bg-transparent stroke-current p-2 outline-none transition-colors duration-300 ease-in-out hover:bg-black/5 hover:stroke-black focus-visible:ring-2 focus-visible:ring-black/50 dark:border-white/25 dark:hover:bg-white/20 hover:dark:stroke-white dark:focus-visible:ring-white/50"
    >
      <svg class="block size-full dark:hidden">
        <use href="/ui.svg#sun"></use>
      </svg>
      <svg class="hidden size-full dark:block">
        <use href="/ui.svg#moon"></use>
      </svg>
    </button>
  </div>
</div>

<style>
  #drawer.open {
    @apply h-full;
  }
</style>

<script is:inline>
  function updateDrawerActiveNav() {
    const pathname = window.location.pathname
    const subpath = pathname.match(/[^/]+/g)
    const navLinks = document.querySelectorAll("#drawer nav a")

    navLinks.forEach((link) => {
      const href = link.getAttribute("href")
      const isActive = pathname === href || "/" + (subpath?.[0] || "") === href

      if (isActive) {
        link.classList.add(
          "pointer-events-none",
          "bg-black",
          "text-white",
          "dark:bg-white",
          "dark:text-black"
        )
      } else {
        link.classList.remove(
          "pointer-events-none",
          "bg-black",
          "text-white",
          "dark:bg-white",
          "dark:text-black"
        )
      }
    })
  }

  function initDrawerSearch() {
    const searchButton = document.getElementById("drawer-search-button")
    searchButton?.addEventListener("click", () => {
      // Close drawer first
      const drawer = document.getElementById("drawer")
      const drawerButton = document.getElementById("header-drawer-button")
      drawer?.classList.remove("open")
      drawerButton?.classList.remove("open")
      // Open search modal
      window.dispatchEvent(new CustomEvent("open-search-modal"))
    })

    updateDrawerActiveNav()
  }

  document.addEventListener("astro:after-swap", initDrawerSearch)
  initDrawerSearch()
</script>
