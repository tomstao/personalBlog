---
import type { CollectionEntry } from "astro:content"
import { getCollection } from "astro:content"

interface Props {
  entry: CollectionEntry<"blog">
}

const { entry } = Astro.props
const { series } = entry.data

// Get all posts in the same series
const seriesPosts = series
  ? (await getCollection("blog"))
      .filter((post) => !post.data.draft && post.data.series?.name === series.name)
      .sort((a, b) => (a.data.series?.part ?? 0) - (b.data.series?.part ?? 0))
  : []

const currentIndex = seriesPosts.findIndex((post) => post.slug === entry.slug)
const prevPost = currentIndex > 0 ? seriesPosts[currentIndex - 1] : null
const nextPost = currentIndex < seriesPosts.length - 1 ? seriesPosts[currentIndex + 1] : null
---

{
  series && seriesPosts.length > 1 && (
    <div class="mb-8 rounded-lg border border-black/10 bg-black/5 p-4 dark:border-white/20 dark:bg-white/5">
      <div class="mb-3 flex items-center gap-2">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-4 w-4 text-black/70 dark:text-white/70"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
          stroke-width="2"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"
          />
        </svg>
        <span class="text-sm font-semibold text-black dark:text-white">{series.name}</span>
        <span class="text-sm text-black/60 dark:text-white/60">
          Part {series.part} of {seriesPosts.length}
        </span>
      </div>

      {/* Progress bar */}
      <div class="mb-4 h-1.5 w-full overflow-hidden rounded-full bg-black/10 dark:bg-white/10">
        <div
          class="h-full rounded-full bg-black transition-all duration-300 dark:bg-white"
          style={`width: ${(series.part / seriesPosts.length) * 100}%`}
        />
      </div>

      {/* Series parts list */}
      <div class="mb-4 space-y-1">
        {seriesPosts.map((post, index) => {
          const isCurrent = post.slug === entry.slug
          return (
            <a
              href={`/blog/${post.slug}`}
              class:list={[
                "flex items-center gap-2 rounded px-2 py-1.5 text-sm transition-colors",
                isCurrent
                  ? "bg-black/10 font-medium text-black dark:bg-white/10 dark:text-white"
                  : "text-black/70 hover:bg-black/5 hover:text-black dark:text-white/70 dark:hover:bg-white/5 dark:hover:text-white",
              ]}
            >
              <span
                class:list={[
                  "flex h-5 w-5 shrink-0 items-center justify-center rounded-full text-xs",
                  isCurrent
                    ? "bg-black text-white dark:bg-white dark:text-black"
                    : "bg-black/10 dark:bg-white/10",
                ]}
              >
                {index + 1}
              </span>
              <span class="truncate">{post.data.title}</span>
            </a>
          )
        })}
      </div>

      {/* Prev/Next navigation */}
      <div class="flex gap-2">
        {prevPost ? (
          <a
            href={`/blog/${prevPost.slug}`}
            class="flex flex-1 items-center gap-2 rounded-md border border-black/10 px-3 py-2 text-sm transition-colors hover:bg-black/5 dark:border-white/20 dark:hover:bg-white/5"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-4 w-4"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2"
            >
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
            </svg>
            <span class="truncate">Part {prevPost.data.series?.part}</span>
          </a>
        ) : (
          <div class="flex-1" />
        )}
        {nextPost ? (
          <a
            href={`/blog/${nextPost.slug}`}
            class="flex flex-1 items-center justify-end gap-2 rounded-md border border-black/10 px-3 py-2 text-sm transition-colors hover:bg-black/5 dark:border-white/20 dark:hover:bg-white/5"
          >
            <span class="truncate">Part {nextPost.data.series?.part}</span>
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-4 w-4"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2"
            >
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
            </svg>
          </a>
        ) : (
          <div class="flex-1" />
        )}
      </div>
    </div>
  )
}
