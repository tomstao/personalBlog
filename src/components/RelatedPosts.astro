---
import type { CollectionEntry } from "astro:content"
import { getCollection } from "astro:content"
import ArrowCard from "@components/ArrowCard"

interface Props {
  entry: CollectionEntry<"blog"> | CollectionEntry<"projects">
  maxPosts?: number
}

const { entry, maxPosts = 3 } = Astro.props
const { collection, slug, data } = entry
const currentTags = data.tags

// Get all posts from the same collection
const allPosts = (await getCollection(collection)).filter(
  (post) => !post.data.draft && post.slug !== slug
)

// Calculate date freshness score (0-1, where 1 is most recent)
const oldestDate = Math.min(...allPosts.map((p) => p.data.date.getTime()))
const newestDate = Math.max(...allPosts.map((p) => p.data.date.getTime()))
const dateRange = newestDate - oldestDate || 1 // Avoid division by zero

function getDateScore(date: Date): number {
  return (date.getTime() - oldestDate) / dateRange
}

// Score posts by matching tags + date freshness
// Tag matches are weighted more heavily (each tag = 1 point)
// Date freshness adds up to 0.5 bonus points
const scoredPosts = allPosts.map((post) => {
  const matchingTags = post.data.tags.filter((tag: string) =>
    currentTags.some((currentTag: string) => currentTag.toLowerCase() === tag.toLowerCase())
  )
  const tagScore = matchingTags.length
  const dateBonus = getDateScore(post.data.date) * 0.5
  return { post, score: tagScore + dateBonus, tagScore, matchingTags }
})

// Filter posts with at least one matching tag and sort by score
const relatedPosts = scoredPosts
  .filter((item) => item.tagScore > 0)
  .sort((a, b) => b.score - a.score)
  .slice(0, maxPosts)
---

{
  relatedPosts.length > 0 && (
    <div class="mt-12 border-t border-black/10 pt-8 dark:border-white/20">
      <div class="mb-4 flex items-center gap-2 text-sm font-semibold uppercase text-black dark:text-white">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-4 w-4"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
          stroke-width="2"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"
          />
        </svg>
        Related {collection === "blog" ? "Posts" : "Projects"}
      </div>
      <ul class="flex flex-col gap-4">
        {relatedPosts.map(({ post, matchingTags }) => (
          <li class="flex flex-col gap-2">
            <div class="flex items-center gap-1.5 text-xs text-black/60 dark:text-white/60">
              <span>Shared topics:</span>
              {matchingTags.map((tag: string, index: number) => (
                <>
                  <span class="rounded bg-black/10 px-1.5 py-0.5 font-medium text-black/80 dark:bg-white/20 dark:text-white/80">
                    {tag}
                  </span>
                  {index < matchingTags.length - 1 && (
                    <span class="text-black/30 dark:text-white/30">Â·</span>
                  )}
                </>
              ))}
            </div>
            <ArrowCard entry={post} />
          </li>
        ))}
      </ul>
    </div>
  )
}
