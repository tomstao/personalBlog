---
interface Props {
  repoUrl: string
}

interface GitHubRepo {
  name: string
  full_name: string
  description: string | null
  html_url: string
  stargazers_count: number
  forks_count: number
  language: string | null
  updated_at: string
  topics: string[]
  open_issues_count: number
}

const { repoUrl } = Astro.props

// Extract owner/repo from GitHub URL
function parseGitHubUrl(url: string): { owner: string; repo: string } | null {
  const match = url.match(/github\.com\/([^/]+)\/([^/]+)/)
  if (!match) return null
  return { owner: match[1], repo: match[2].replace(/\.git$/, "") }
}

const parsed = parseGitHubUrl(repoUrl)
let repoData: GitHubRepo | null = null

if (parsed) {
  try {
    const response = await fetch(`https://api.github.com/repos/${parsed.owner}/${parsed.repo}`, {
      headers: {
        Accept: "application/vnd.github.v3+json",
        "User-Agent": "astro-blog",
      },
    })

    if (response.ok) {
      repoData = await response.json()
    }
  } catch {
    // Network error - will fall back to simple link
  }
}

function formatNumber(num: number): string {
  if (num >= 1000) {
    return (num / 1000).toFixed(1).replace(/\.0$/, "") + "k"
  }
  return num.toString()
}

function formatDate(dateString: string): string {
  const date = new Date(dateString)
  return new Intl.DateTimeFormat("en-US", {
    month: "short",
    day: "numeric",
    year: "numeric",
  }).format(date)
}

// Language colors from GitHub
const languageColors: Record<string, string> = {
  TypeScript: "#3178c6",
  JavaScript: "#f1e05a",
  Python: "#3572A5",
  Rust: "#dea584",
  Go: "#00ADD8",
  Java: "#b07219",
  "C++": "#f34b7d",
  C: "#555555",
  Ruby: "#701516",
  PHP: "#4F5D95",
  Swift: "#F05138",
  Kotlin: "#A97BFF",
  Astro: "#ff5a03",
  Vue: "#41b883",
  Svelte: "#ff3e00",
  HTML: "#e34c26",
  CSS: "#563d7c",
  SCSS: "#c6538c",
  Shell: "#89e051",
}
---

{
  repoData ? (
    <a
      href={repoData.html_url}
      target="_blank"
      rel="noopener noreferrer"
      class="group flex flex-col gap-3 rounded-lg border border-black/15 p-4 transition-colors duration-300 ease-in-out hover:bg-black/5 dark:border-white/20 hover:dark:bg-white/10"
    >
      <div class="flex items-start justify-between gap-3">
        <div class="flex items-center gap-2">
          <img src="/lucide/github.svg" alt="GitHub" class="size-5 dark:invert" />
          <span class="font-semibold text-black group-hover:underline dark:text-white">
            {repoData.full_name}
          </span>
        </div>
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke-width="2.5"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="shrink-0 stroke-current group-hover:stroke-black group-hover:dark:stroke-white"
        >
          <line
            x1="5"
            y1="12"
            x2="19"
            y2="12"
            class="translate-x-4 scale-x-0 transition-all duration-300 ease-in-out group-hover:translate-x-1 group-hover:scale-x-100"
          />
          <polyline
            points="12 5 19 12 12 19"
            class="translate-x-0 transition-all duration-300 ease-in-out group-hover:translate-x-1"
          />
        </svg>
      </div>

      {repoData.description && <p class="line-clamp-2 text-sm">{repoData.description}</p>}

      <div class="flex flex-wrap items-center gap-3 text-sm">
        {repoData.language && (
          <div class="flex items-center gap-1.5">
            <span
              class="size-3 rounded-full"
              style={`background-color: ${languageColors[repoData.language] || "#8b8b8b"}`}
            />
            <span>{repoData.language}</span>
          </div>
        )}

        <div class="flex items-center gap-1">
          <img src="/lucide/star.svg" alt="Stars" class="size-4 dark:invert" />
          <span>{formatNumber(repoData.stargazers_count)}</span>
        </div>

        <div class="flex items-center gap-1">
          <img src="/lucide/git-fork.svg" alt="Forks" class="size-4 dark:invert" />
          <span>{formatNumber(repoData.forks_count)}</span>
        </div>

        <div class="text-black/50 dark:text-white/50">
          Updated {formatDate(repoData.updated_at)}
        </div>
      </div>

      {repoData.topics && repoData.topics.length > 0 && (
        <ul class="flex flex-wrap gap-1">
          {repoData.topics.slice(0, 5).map((topic) => (
            <li class="rounded bg-black/5 px-1.5 py-0.5 text-xs text-black/75 dark:bg-white/20 dark:text-white/75">
              {topic}
            </li>
          ))}
        </ul>
      )}
    </a>
  ) : (
    <a
      href={repoUrl}
      target="_blank"
      rel="noopener noreferrer"
      class="group flex items-center gap-2 truncate rounded border border-black/25 px-3 py-1.5 text-xs hover:bg-black/5 dark:border-white/25 hover:dark:bg-white/15 md:text-sm lg:text-base"
    >
      <img src="/lucide/github.svg" alt="GitHub" class="size-4 dark:invert" />
      <span class="text-current group-hover:text-black group-hover:dark:text-white">
        View Repository
      </span>
    </a>
  )
}
